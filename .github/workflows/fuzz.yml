# TxGate Fuzz Testing Pipeline
#
# This workflow runs cargo-fuzz against security-critical code to find
# potential crashes, panics, or unexpected behavior. Fuzzing runs on a
# schedule and can be triggered manually.
#
# Fuzz targets:
# - ethereum_parser: Exercises Ethereum transaction parsing
# - policy_rules: Exercises policy engine evaluation

name: Fuzz

on:
  # Run daily at 3 AM UTC
  schedule:
    - cron: "0 3 * * *"

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      fuzz_duration:
        description: "Fuzzing duration per target (in seconds)"
        required: false
        default: "1800"
        type: string
      target:
        description: "Specific target to fuzz (leave empty for all)"
        required: false
        default: ""
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  fuzz:
    name: Fuzz Testing
    runs-on: ubuntu-latest
    # Don't run on forks (they may not have the necessary secrets/permissions)
    if: github.repository == 'luisjpf/txgate'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - name: Cache cargo registry and build
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: fuzz -> target

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Create corpus directories
        run: |
          mkdir -p fuzz/corpus/ethereum_parser
          mkdir -p fuzz/corpus/policy_rules

      # Fuzz ethereum_parser target
      - name: Fuzz ethereum_parser
        if: ${{ github.event.inputs.target == '' || github.event.inputs.target == 'ethereum_parser' }}
        working-directory: fuzz
        run: |
          DURATION=${{ github.event.inputs.fuzz_duration || '1800' }}
          echo "Fuzzing ethereum_parser for ${DURATION} seconds..."
          timeout ${DURATION}s cargo +nightly fuzz run ethereum_parser -- \
            -max_total_time=${DURATION} \
            -max_len=65536 \
            || true
        continue-on-error: true

      # Fuzz policy_rules target
      - name: Fuzz policy_rules
        if: ${{ github.event.inputs.target == '' || github.event.inputs.target == 'policy_rules' }}
        working-directory: fuzz
        run: |
          DURATION=${{ github.event.inputs.fuzz_duration || '1800' }}
          echo "Fuzzing policy_rules for ${DURATION} seconds..."
          timeout ${DURATION}s cargo +nightly fuzz run policy_rules -- \
            -max_total_time=${DURATION} \
            -max_len=131072 \
            || true
        continue-on-error: true

      # Check for crash artifacts
      - name: Check for crashes
        id: check_crashes
        run: |
          if [ -d "fuzz/artifacts" ] && [ "$(find fuzz/artifacts -type f 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "crashes_found=true" >> $GITHUB_OUTPUT
            echo "::error::Fuzzing found crashes! See artifacts for details."
            find fuzz/artifacts -type f -exec echo "Crash: {}" \;
          else
            echo "crashes_found=false" >> $GITHUB_OUTPUT
            echo "No crashes found during fuzzing."
          fi

      # Upload crash artifacts if found
      - name: Upload crash artifacts
        if: steps.check_crashes.outputs.crashes_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crashes-${{ github.run_id }}
          path: fuzz/artifacts/
          retention-days: 30

      # Upload corpus for potential reuse
      - name: Upload corpus
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-corpus-${{ github.run_id }}
          path: fuzz/corpus/
          retention-days: 7

      # Fail the job if crashes were found
      - name: Fail on crashes
        if: steps.check_crashes.outputs.crashes_found == 'true'
        run: |
          echo "Fuzzing discovered crashes. Please investigate the uploaded artifacts."
          exit 1

  # Optional: Create an issue if crashes are found
  report-crashes:
    name: Report Crashes
    runs-on: ubuntu-latest
    needs: fuzz
    if: failure() && needs.fuzz.result == 'failure'

    steps:
      - name: Create issue for crashes
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Fuzz testing found crashes - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Fuzz Testing Report

            **Run ID:** ${{ github.run_id }}
            **Workflow:** ${{ github.workflow }}
            **Triggered by:** ${{ github.event_name }}

            ### Summary
            The scheduled fuzz testing run discovered potential crashes in the codebase.

            ### Next Steps
            1. Download the crash artifacts from the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Reproduce the crash locally using \`cargo +nightly fuzz run <target> <crash_file>\`
            3. Fix the underlying issue
            4. Add the fixed input to the corpus as a regression test

            ### Labels
            - security
            - bug
            - fuzzing
            `;

            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'fuzzing',
              per_page: 10
            });

            const existingIssue = issues.data.find(i =>
              i.title.includes('Fuzz testing found crashes')
            );

            if (existingIssue) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `New crashes found in run [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'bug', 'fuzzing']
              });
            }
